# ã‚³ãƒ¼ãƒ‰ã«ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ 
# SECURITY NOTE FOR REVIEWERS:
# All external actions in this workflow are pinned to specific versions.
# We use either:
# 1. Verified tags (vX.Y.Z) from trusted publishers
# 2. Specific commit SHAs when tags are not preferred
#
# When updating any action, always:
# - Check for security advisories for the action
# - Verify the publisher's reputation
# - Test the new version in a controlled environment first
# - Update this policy comment with any changes
---
name: Test & Build

on:
  push:
    branches:
      - develop
    paths-ignore:
      - .devcontainer/**
      - assets/**
      - README.md
      - .gitignore
      - .cz_config.js
      - .pre-commit-config.yaml
      - "**.code-workspace"
  pull_request:
    branches:
      - main
      - develop

defaults:
  run:
    shell: bash

env:
  python-version: 3.12.3
  node-version: 22

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # SECURITY CHECKS GROUP
  # ============================================================
  security-dependency-review:
    name: ðŸ”’ Security - Dependency Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check out Git repository
        # v4.1.1ã‚’ä½¿ç”¨ (OIDCãƒˆãƒ¼ã‚¯ãƒ³å¯¾å¿œã€å®‰å®šç‰ˆ)
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0
      - name: Dependency Review
        # v3.1.4ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: actions/dependency-review-action@v3.1.4
        with:
          fail-on-severity: high
          comment-summary-in-pr: true
      - name: Report Status
        run: |
          echo "### ðŸ”’ Dependency Review Complete" >> $GITHUB_STEP_SUMMARY
          echo "Scanned for vulnerable dependencies in PR changes." >> $GITHUB_STEP_SUMMARY

  security-npm-audit:
    name: ðŸ”’ Security - NPM Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
      - name: Install Node.js
        # actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 = v4.0.1
        uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8
        with:
          node-version: ${{ env.node-version }}
      - name: NPM Audit
        run: |
          # npm auditã‚’å®Ÿè¡Œï¼ˆé«˜ãƒªã‚¹ã‚¯ã®è„†å¼±æ€§ã®ã¿å¤±æ•—ã¨ã™ã‚‹ï¼‰
          echo "### NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          npm audit --production --audit-level=high || {
            echo "::warning::High severity vulnerabilities found in production dependencies"
            echo "âš ï¸ High severity vulnerabilities found in production dependencies" >> $GITHUB_STEP_SUMMARY
            npm audit --production --audit-level=high >> $GITHUB_STEP_SUMMARY
          }
      - name: Report Status
        run: |
          echo "### ðŸ”’ NPM Security Audit Complete" >> $GITHUB_STEP_SUMMARY

  # CodeQLè§£æžã‚’è¿½åŠ ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æžï¼‰
  security-codeql:
    name: ðŸ”’ Security - CodeQL Analysis
    runs-on: ubuntu-latest
    # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¨PRã®ã¿ã§å®Ÿè¡Œ
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        # v2.22.8ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: github/codeql-action/init@v2.22.8
        with:
          languages: python, javascript
      - name: Perform CodeQL Analysis
        # v2.22.8ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: github/codeql-action/analyze@v2.22.8
      - name: Report Status
        run: |
          echo "### ðŸ”’ CodeQL Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "Static code analysis completed for security vulnerabilities." >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # LINT CHECKS GROUP
  # ============================================================
  lint-workflow:
    name: ðŸ” Lint - Workflow Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Check workflow file
        # ç‰¹å®šã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å›ºå®šï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ï¼‰
        uses: docker://rhysd/actionlint@sha256:55c184eca5f8d372e6fbaf3bb3af1ff2b0a299c994ec61dd738c69d616637f9d
        with:
          args: -color
      - name: Check typos
        # v1.16.8ã‚’ä½¿ç”¨ (å®‰å®šç‰ˆ)
        uses: crate-ci/typos@v1.16.8
      - name: Report Status
        run: |
          echo "### âœ… Workflow Lint Passed" >> $GITHUB_STEP_SUMMARY
          echo "All GitHub Actions workflow files are valid." >> $GITHUB_STEP_SUMMARY

  lint-python:
    name: ðŸ” Lint - Python Code
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up Python ${{ env.python-version }}
        # v5.0.0ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: actions/setup-python@v5.0.0
        with:
          python-version: ${{ env.python-version }}
      - name: Restore cache pip dependencies
        # v4.0.2ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: actions/cache@v4.0.2
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            .venv
          key: ${{ runner.os }}-python${{ env.python-version }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python${{ env.python-version }}-poetry
      - name: Bootstrap poetry
        run: |
          curl -sL https://install.python-poetry.org | python - -y
        shell: bash
      - name: Update PATH
        run: echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        shell: bash
      - name: Configure poetry
        run: poetry config virtualenvs.in-project false
        shell: bash
      - name: Install dependencies
        shell: bash
        run: |
          poetry install --no-interaction --no-root --only main,dev
      - name: Check for vulnerable dependencies
        run: |
          poetry run pip install safety
          poetry run safety check
      - name: Run Python Linters
        run: |
          poetry run ruff check .
          poetry run mypy .
      - name: Report Status
        run: |
          echo "### âœ… Python Lint Passed" >> $GITHUB_STEP_SUMMARY
          echo "All Python files pass linting requirements." >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # TESTS GROUP
  # ============================================================
  test-unit:
    name: ðŸ§ª Test - Unit
    runs-on: ubuntu-latest
    needs: [lint-workflow, lint-python]
    timeout-minutes: 10
    permissions:
      contents: read
      checks: write # ãƒ†ã‚¹ãƒˆçµæžœå‡ºåŠ›ç”¨ã®æ¨©é™ã‚’è¿½åŠ 
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up Python ${{ env.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.python-version }}
      - name: Restore cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            .venv
          key: ${{ runner.os }}-python${{ env.python-version }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python${{ env.python-version }}-poetry
      - name: Bootstrap poetry
        run: |
          curl -sL https://install.python-poetry.org | python - -y
        shell: bash
      - name: Update PATH
        run: echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        shell: bash
      - name: Configure poetry
        run: poetry config virtualenvs.in-project false
        shell: bash
      - name: Install dependencies
        shell: bash
        run: |
          poetry install --no-interaction --no-root --only main,dev
      - name: Run Unit Tests
        run: |
          # é€šå¸¸ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸æœ‰ã€ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ãªã—ï¼‰
          poetry run pytest --cov=app.py --cov=features --cov=i18n --cov=scripts --cov-report=xml --cov-report=term -n 2 --dist loadfile --durations=10 --cache-clear --maxfail=5 --verbose -k "not e2e" --benchmark-disable
      - name: Report Status
        run: |
          echo "### âœ… Unit Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "All unit tests passing with coverage." >> $GITHUB_STEP_SUMMARY

  test-e2e:
    name: ðŸ§ª Test - E2E (${{ matrix.os }} / ${{ matrix.python-version }} / ${{ matrix.browser }})
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - ubuntu-22.04
          - ubuntu-20.04
        python-version:
          - 3.12.3
          - 3.11
        browser:
          - chromium
          - firefox
          - webkit
        exclude:
          # Ubuntuã¨Webkitã€Chromiumã®çµ„ã¿åˆã‚ã›ã‚’é™¤å¤–
          - os: ubuntu-latest
            browser: webkit
          - os: ubuntu-22.04
            browser: webkit
          - os: ubuntu-20.04
            browser: webkit
          - os: ubuntu-latest
            browser: chromium
          - os: ubuntu-22.04
            browser: chromium
          - os: ubuntu-20.04
            browser: chromium
          # Windowsã¨Webkitã®çµ„ã¿åˆã‚ã›ã‚’é™¤å¤–
          - os: windows-latest
            browser: webkit
        include:
          # Windowsã®ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ã‚’15åˆ†ã«è¨­å®šï¼ˆWebkitã¯é™¤å¤–ï¼‰
          - os: windows-latest
            python-version: 3.12.3
            browser: chromium
            timeout-minutes: 15
          - os: windows-latest
            python-version: 3.11
            browser: chromium
            timeout-minutes: 15
          - os: windows-latest
            python-version: 3.12.3
            browser: firefox
            timeout-minutes: 15
          - os: windows-latest
            python-version: 3.11
            browser: firefox
            timeout-minutes: 15
          # æœ€ã‚‚ä¸€èˆ¬çš„ãªç’°å¢ƒã‚’å„ªå…ˆçš„ã«ãƒ†ã‚¹ãƒˆ
          - os: macos-latest
            python-version: 3.12.3
            browser: chromium
            priority: high
      max-parallel: 10
    runs-on: ${{ matrix.os }}
    needs: [test-unit]
    permissions:
      contents: read
    timeout-minutes: ${{ matrix.timeout-minutes || 10 }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Restore cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            .venv
            %LOCALAPPDATA%\pypoetry\Cache
            %USERPROFILE%\.cache\pypoetry
          key: ${{ matrix.os }}-python${{ matrix.python-version }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ matrix.os }}-python${{ matrix.python-version }}-poetry
      - name: Install Poetry (Windows)
        if: ${{ runner.os == 'Windows' }}
        # v1.3.4ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: snok/install-poetry@v1.3.4
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
      - name: Bootstrap poetry (Non-Windows)
        if: matrix.os != 'Windows'
        run: |
          curl -sL https://install.python-poetry.org | python - -y
        shell: bash
      - name: Update PATH (Non-Windows)
        if: runner.os != 'Windows'
        run: |
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        shell: bash
      - name: Configure poetry (Non-Windows)
        if: matrix.os != 'Windows'
        run: |
          poetry config virtualenvs.in-project false
        shell: bash
      - name: Install dependencies
        shell: bash
        run: |
          poetry install --no-interaction --no-root --only main,dev
      - name: Cache Playwright browsers
        # v4.0.2ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: actions/cache@v4.0.2
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
            ~/Library/Caches/ms-playwright
            /home/runner/.cache/ms-playwright
            /Users/runner/Library/Caches/ms-playwright
            %USERPROFILE%\AppData\Local\ms-playwright
          key: ${{ matrix.os }}-playwright-${{ matrix.browser }}-${{ hashFiles('**/poetry.lock') }}
      - name: Install Playwright Browser
        run: |
          poetry run playwright install --with-deps ${{ matrix.browser }}

      # E2Eãƒ†ã‚¹ãƒˆç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
      - name: Generate hash for E2E test files (Unix)
        id: e2e-hash
        if: runner.os != 'Windows'
        run: |
          # E2Eãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
          HASH=$(find app.py features i18n tests/e2e -type f -name "*.py" -o -name "*.j2" -o -name "*.csv" -o -name "*.yaml" -o -name "*.txt" | sort | xargs cat | sha256sum | cut -d ' ' -f 1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "E2E test files hash: $HASH"
        shell: bash

      - name: Generate hash for E2E test files (Windows)
        id: e2e-hash-win
        if: runner.os == 'Windows'
        run: |
          # Windowsç”¨ã®ãƒãƒƒã‚·ãƒ¥è¨ˆç®—
          $files = Get-ChildItem -Path app.py,features,i18n,tests\e2e -Recurse -Include *.py,*.j2,*.csv,*.yaml,*.txt | Sort-Object -Property FullName
          $content = $files | Get-Content | Out-String
          $hash = (Get-FileHash -InputStream ([System.IO.MemoryStream]::new([System.Text.Encoding]::UTF8.GetBytes($content))) -Algorithm SHA256).Hash.ToLower()
          echo "hash=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "E2E test files hash: $hash"
        shell: pwsh

      # ãƒãƒƒã‚·ãƒ¥å€¤ã‚’çµ±åˆ
      - name: Set combined hash
        id: combined-hash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            HASH="${{ steps.e2e-hash-win.outputs.hash }}"
          else
            HASH="${{ steps.e2e-hash.outputs.hash }}"
          fi
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Combined hash: $HASH"
        shell: bash

      # E2Eãƒ†ã‚¹ãƒˆçµæžœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¾©å…ƒ
      - name: Restore E2E test results cache
        # v4.0.2ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: actions/cache@v4.0.2
        id: e2e-cache
        with:
          path: |
            .pytest_cache
            .benchmarks
          key: e2e-${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.browser }}-${{ steps.combined-hash.outputs.hash }}

      - name: Configure Windows for UTF-8
        if: runner.os == 'Windows'
        run: |
          # Windowsç’°å¢ƒã§UTF-8ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®š
          chcp 65001
        shell: cmd

      - name: E2E Tests (not chromium)
        if: |
          matrix.browser != 'chromium' && steps.e2e-cache.outputs.cache-hit != 'true'
        run: |
          # E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ãªã—ï¼‰
          poetry run pytest -vv --browser ${{ matrix.browser }} -m "benchmark" --benchmark-disable
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1

      - name: E2E Tests with benchmark (Chromium only)
        if: |
          matrix.browser == 'chromium' && steps.e2e-cache.outputs.cache-hit != 'true'
        run: |
          # E2Eãƒ†ã‚¹ãƒˆã®ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯å®Ÿè¡Œï¼ˆChromiumã®ã¿ï¼‰
          poetry run pytest -vv --browser ${{ matrix.browser }} -m "benchmark" --benchmark-verbose --benchmark-save=github-actions-${{ matrix.browser }} --benchmark-columns=min,max,mean,stddev,median,ops --benchmark-sort=mean --benchmark-histogram=none
        env:
          PYTHONIOENCODING: utf-8
          PYTHONUTF8: 1

      - name: Skip E2E Tests (Cache Hit)
        if: steps.e2e-cache.outputs.cache-hit == 'true'
        run: |
          echo "E2E tests skipped - using cached results from previous run with identical code"
          echo "Cache key: e2e-${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.browser }}-${{ steps.combined-hash.outputs.hash }}"
          echo "::notice::E2E tests skipped - using cached results (no code changes detected)"
          echo "### âœ… E2E Tests Skipped - Using Cached Results" >> $GITHUB_STEP_SUMMARY
          echo "No changes detected in E2E test files or application code." >> $GITHUB_STEP_SUMMARY
          echo "Cache key: \`e2e-${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.browser }}-${{ steps.combined-hash.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY

      # E2Eãƒ†ã‚¹ãƒˆçµæžœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œï¼‰
      - name: Save E2E test results cache
        if: steps.e2e-cache.outputs.cache-hit != 'true'
        # v4.0.0ã‚’ä½¿ç”¨ (å®‰å®šç‰ˆ)
        uses: actions/cache/save@v4.0.0
        with:
          path: |
            .pytest_cache
            .benchmarks
          key: e2e-${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.browser }}-${{ steps.combined-hash.outputs.hash }}

      # E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæžœã‚’ã‚µãƒžãƒªãƒ¼ã«è¡¨ç¤º
      - name: Add E2E test execution summary
        if: steps.e2e-cache.outputs.cache-hit != 'true'
        run: |
          echo "::notice::E2E tests executed - results cached for future runs"
          echo "### ðŸ§ª E2E Tests Executed" >> $GITHUB_STEP_SUMMARY
          echo "Test results have been cached for future runs with the same code." >> $GITHUB_STEP_SUMMARY
          echo "Cache key: \`e2e-${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.browser }}-${{ steps.combined-hash.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # ANALYZE GROUP
  # ============================================================
  analyze-code:
    name: ðŸ“Š Analysis - Code Complexity
    # https://github.com/terryyin/lizard
    runs-on: ubuntu-latest
    needs: [lint-workflow, lint-python]
    permissions:
      contents: read
    env:
      LIZARD_CCN_COUNT: 10
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up Python ${{ env.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.python-version }}
      - name: Restore cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            .venv
            %LOCALAPPDATA%\pypoetry\Cache
            %USERPROFILE%\.cache\pypoetry
          key: ${{ runner.os }}-python${{ env.python-version }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-python${{ env.python-version }}-poetry
      - name: Bootstrap poetry
        run: |
          curl -sL https://install.python-poetry.org | python - -y
        shell: bash
      - name: Update PATH
        run: echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        shell: bash
      - name: Configure poetry
        run: poetry config virtualenvs.in-project false
        shell: bash
      - name: Install dependencies
        shell: bash
        run: |
          poetry install --no-interaction --no-root --only main,dev
      - name: Run lizard (analyze CCN for production codes)
        run: |
          poetry run lizard -x "./node_modules/*" -x "./.venv/*" -x "./build/*" -x "./dist/*" -x "./htmlcov/*" -x "./tests/*" --CCN "$LIZARD_CCN_COUNT"
      - name: Show AST (app.py)
        run: |
          python <<EOF
          import ast
          print(ast.dump(ast.parse(open("app.py").read()), indent=2))
          EOF
      - name: Show AST (features/*.py)
        run: |
          python <<EOF
          import ast
          import os
          import pprint

          target_dir = "./features"
          ast_trees = {}
          for file in os.listdir(target_dir):
              if file.endswith(".py"):
                  ast_trees[file] = ast.dump(ast.parse(open(os.path.join(target_dir, file)).read()), indent=2)

          pprint.pprint(ast_trees, width=100, compact=False)
          EOF
      - name: Report Status
        run: |
          echo "### ðŸ“Š Code Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "Code complexity and AST analysis performed successfully." >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # BUILD GROUP
  # ============================================================
  build-desktop:
    name: ðŸ—ï¸ Build - Desktop (${{ matrix.os }})
    strategy:
      matrix:
        os:
          - macos-latest
          - windows-latest
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.os == 'windows-latest' }}
    needs: [test-unit, security-npm-audit] # NPMç›£æŸ»ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒ“ãƒ«ãƒ‰
    permissions:
      contents: read
      security-events: write # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’è¿½åŠ 
    timeout-minutes: 5
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.node-version }}
      - name: Restore cache node-electron dependencies
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node${{ env.node-version }}-electron-deps-${{ hashFiles('**/package-lock.json') }}
      - name: Install stlite
        run: |
          npm install
      - name: Restore cache node-electron dependencies
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-node${{ env.node-version }}-electron-deps-${{ hashFiles('**/package-lock.json') }}
      - name: Restore cache electron-builder (Windows)
        # https://github.com/electron/get#usage
        uses: actions/cache@v4
        with:
          path: |
            %LOCALAPPDATA%/electron/Cache
            ~/AppData/Local/electron/Cache/
          key: ${{ runner.os }}-node-electron-builder-${{ hashFiles('**/package-lock.json') }}
        if: ${{ runner.os == 'Windows' }}
      - name: Restore cache electron-builder (MacOS)
        # https://github.com/electron/get#usage
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/electron/
          key: ${{ runner.os }}-node-electron-builder-${{ hashFiles('**/package-lock.json') }}
        if: ${{ runner.os == 'MacOS' }}
      - name: Dump package
        run: |
          npm run dump
        # TODO: stliteã®Windowsç’°å¢ƒã®ãƒ“ãƒ«ãƒ‰å¤±æ•—ãŒè§£æ¶ˆã—ãŸã‚‰å‰Šé™¤
        if: ${{ runner.os == 'MacOS' }}
      - name: Build
        run: |
          npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # NODE_OPTIONSã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
          NODE_OPTIONS: --max-http-header-size=8192 --no-experimental-fetch --disable-proto=throw --disallow-code-generation-from-strings
        # TODO: stliteã®Windowsç’°å¢ƒã®ãƒ“ãƒ«ãƒ‰å¤±æ•—ãŒè§£æ¶ˆã—ãŸã‚‰å‰Šé™¤
        if: ${{ runner.os == 'MacOS' }}
      - name: Upload artifact (Windows)
        # v4.3.1ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: actions/upload-artifact@v4.3.1
        with:
          name: ${{ runner.os }}-build-artifact
          path: ./dist/*.exe
          retention-days: 3
          compression-level: 9
        if: ${{ runner.os == 'Windows' }}
      - name: Upload artifact (MacOS)
        # v4.3.1ã‚’ä½¿ç”¨ (æœ€æ–°ã®å®‰å®šç‰ˆ)
        uses: actions/upload-artifact@v4.3.1
        with:
          name: ${{ runner.os }}-build-artifact
          path: ./dist/*.dmg
          retention-days: 3
          compression-level: 9
        if: ${{ runner.os == 'MacOS' }}
      - name: Report Status
        run: |
          echo "### ðŸ—ï¸ Desktop Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "Desktop application built successfully for ${{ runner.os }}." >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # WORKFLOW SUMMARY
  # ============================================================
  workflow-summary:
    name: ðŸ“‹ Workflow Summary
    if: always()
    needs:
      [
        security-dependency-review,
        security-npm-audit,
        security-codeql,
        lint-workflow,
        lint-python,
        test-unit,
        test-e2e,
        analyze-code,
        build-desktop,
      ]
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "### ðŸ“‹ Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | Dependency Review | ${{ needs.security-dependency-review.result == 'success' && 'âœ… Passed' || (github.event_name != 'pull_request' && 'âž– Skipped') || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | NPM Audit | ${{ needs.security-npm-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | CodeQL Analysis | ${{ needs.security-codeql.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | Workflow Files | ${{ needs.lint-workflow.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | Python Code | ${{ needs.lint-python.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Unit Tests | ${{ needs.test-unit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | E2E Tests | ${{ needs.test-e2e.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Analysis | Code Complexity | ${{ needs.analyze-code.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | Desktop App | ${{ needs.build-desktop.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
